<!DOCTYPE html>
<html>
  <head>
    <title>調査項目のリスト</title>
    <link rel="stylesheet"
        href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
    <script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
  </head>
  <body>
    <div class="container">
      <div class="col-md-4"></div>
      <form id="records" role="form" class="col-md-4">
        <h1>Annict Season finder</h1>
        <div class="form-group">
          <label for="user_name">UserID</label>
          <input type="text" class="form-control" id="user_name"
               placeholder="naninunenosi" value="miyau_skmt">
        </div>
        <div class="form-group">
          <label for="year">Year</label>
          <input type="text" class="form-control" id="year"
               placeholder="2018" value="2018">
        </div>
        <div class="form-group">
          <label for="season">Season</label>
          <input type="text" class="form-control" id="season"
               placeholder="autumn" value="autumn">
        </div>
      </form>
      <a href="new.html" class="btn btn-primary">うひょおお</a>
      <div id="chart_div"></div>
      </div>
    </div>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script>
      $(function(){
        const URLJoin = (...args) =>
          args
              .join('/')
                  .replace(/[\/]+/g, '/')
                      .replace(/^(.+):\//, '$1://')
                          .replace(/^file:/, 'file:/')
                              .replace(/\/(\?|&|#[^!])/g, '$1')
                                  .replace(/\?/g, '&')
                                      .replace('&', '?');

        const RatingToInt = function(str) {
          if (str == 'great') return 5;
          if (str == 'good')  return 4;
          if (str == 'average')return 3;
          if (str == 'bad')   return 2;
          else return null;
        }
        var form = $("form#records")
      

        var chart; // google chart
        var records; // [anime_name][number] = record
        var max_episode_number;
        
        var drawChart = function() {
          var data = new google.visualization.DataTable();
          let title_to_number_map = new Map();
          let title_to_index = 1;
          let records_count = 0;
          data.addColumn('number', '話数');
          for (let title in records) {
            data.addColumn('number', title);
            title_to_number_map[title] = title_to_index++;
            records_count++;
          }
          console.log("records_count: ", records_count);
          for (let i = 1; i <= max_episode_number; i++) {
            undefined_array = new Array(records_count + 1);
            undefined_array.fill(null);
            undefined_array[0] = i;
            data.addRow(undefined_array);
          }
          console.log("number of rows", data.getNumberOfRows());
          console.log("number of columns", data.getNumberOfColumns());
          console.log(records);
          for (let title in records) {
            for (let number in records[title]) {
              rate = RatingToInt(records[title][number].rating_state);
              console.log("row: ", records[title][number].episode.number - 1,
              ", column: ", title_to_number_map[title], ", rate:", records[title][number].rating_state);
              data.setValue(records[title][number].episode.number-1, title_to_number_map[title], rate);
            }
          }
          console.log("after table: ", data);
          var options = {
            title: 'Company Performance',
            hAxis: {title: 'Story Number',  titleTextStyle: {color: '#333'}},
            vAxis: {minValue: 0}
          };

          if (!chart) {
            chart = new google.visualization.AreaChart(document.getElementById('chart_div'));
          }
          chart.draw(data, options);
        }
        var update = function(){
          var user_name = form.find("input[id='user_name']").val();
          var year      = form.find("input[id='year']").val();
          var season    = form.find("input[id='season']").val();
          var season_name = year + "-" + season
          var path = URLJoin("http://localhost:8080/polls/", user_name, season_name, "?key=abc123")
          var json_records;
          $.get(path, null, null, "json")
            .done(function(result){
              let record_objects = JSON.parse(JSON.stringify(result));
              records = null;
              records = new Map();
              max_episode_number = '0';
              console.log(record_objects);
              for (let i in record_objects) {
                // recordsに各アニメと話数で構造化して登録
                let obj = record_objects[i];
                if ( ! records.has(obj["work"]["title"])) {
                  records[obj.work.title] = new Map();
                }
                records[obj.work.title][obj.episode.number] = obj

                // max_episodeを更新
                max_episode_number = Math.max(obj.episode.number, max_episode_number);
              }
            });
          google.charts.load('current', {'packages':['corechart']});
          google.charts.setOnLoadCallback(drawChart);
          window.setTimeout(update, 10000);
        }
        update();
      });
    </script>
  </body>
</html>
